<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absen Voice Recognition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            width: 90%;
            max-width: 800px;
            margin: 20px auto;
            text-align: center;
        }

        h1 {
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 2.5rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #e2e8f0;
        }

        .nav-tab {
            padding: 15px 30px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1.1rem;
            color: #4a5568;
            transition: all 0.3s ease;
            margin: 0 5px;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }

        .nav-tab:hover {
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin: 30px 0;
            padding: 20px;
            border-radius: 15px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
        }

        .section h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .recording {
            background: linear-gradient(45deg, #e53e3e, #ff6b6b) !important;
            animation: pulse 1.5s infinite;
        }

        .cancel-btn {
            background: linear-gradient(45deg, #f56565, #fc8181);
        }

        .cancel-btn:hover {
            background: linear-gradient(45deg, #e53e3e, #f56565);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(229, 62, 62, 0); }
            100% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0); }
        }

        input, select {
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            width: 300px;
            margin: 10px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group {
            margin: 15px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #4a5568;
        }

        .voice-list, .attendance-list {
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            background: white;
        }

        .voice-item, .attendance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
            margin-bottom: 10px;
            border-radius: 8px;
            background: #f8fafc;
        }

        .voice-item:last-child, .attendance-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }

        .result.show {
            opacity: 1;
            transform: translateY(0);
        }

        .success {
            background: linear-gradient(45deg, #48bb78, #68d391);
            color: white;
            border: 2px solid #38a169;
        }

        .error {
            background: linear-gradient(45deg, #e53e3e, #fc8181);
            color: white;
            border: 2px solid #c53030;
        }

        .warning {
            background: linear-gradient(45deg, #ed8936, #f6ad55);
            color: white;
            border: 2px solid #d69e2e;
        }

        .status {
            margin: 10px 0;
            font-weight: 500;
            color: #4a5568;
        }

        .waveform {
            height: 60px;
            background: #f1f5f9;
            border-radius: 10px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .wave-bar {
            width: 3px;
            background: #667eea;
            margin: 0 1px;
            border-radius: 1px;
            animation: wave 1s infinite ease-in-out;
            transform-origin: center;
        }

        @keyframes wave {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1); }
        }

        .delete-btn {
            background: #e53e3e;
            padding: 8px 15px;
            font-size: 0.9rem;
            margin: 0;
        }

        .delete-btn:hover {
            background: #c53030;
        }

        .admin-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .time-settings {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .late-badge {
            background: #fed7d7;
            color: #c53030;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .on-time-badge {
            background: #c6f6d5;
            color: #276749;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .recording-controls {
            display: none;
            margin: 15px 0;
        }

        .recording-controls.show {
            display: block;
        }

        .current-time {
            font-size: 1.1rem;
            color: #4a5568;
            margin: 10px 0;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
                width: 95%;
            }

            .nav-tabs {
                flex-wrap: wrap;
            }

            .nav-tab {
                padding: 10px 15px;
                font-size: 1rem;
            }

            input, select {
                width: 100%;
                max-width: 300px;
            }

            .admin-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎤 Sistem Absen Voice Recognition</h1>
	<h6> made by: Siswa Atisa Dipamkara</h6>
	<br>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('register')">📝 Registrasi</button>
            <button class="nav-tab" onclick="switchTab('attendance')">✅ Absen</button>
            <button class="nav-tab" onclick="switchTab('admin')">⚙️ Admin</button>
        </div>

        <!-- Current Time Display -->
        <div class="current-time" id="currentTime"></div>

        <!-- Registrasi Tab -->
        <div class="tab-content active" id="registerTab">
            <div class="section">
                <h2>Registrasi Suara</h2>
                <div class="form-group">
                    <label for="nameInput">Nama Lengkap:</label>
                    <input type="text" id="nameInput" placeholder="Masukkan nama lengkap">
                </div>
                <div class="form-group">
                    <label for="classInput">Kelas:</label>
                    <select id="classInput">
                        <option value="">Pilih Kelas</option>
			<option value="12.1">12.1</option>
                        <option value="12.2">12.2</option>
                        <option value="12.3">12.3</option>
                    </select>
                </div>
                
                <button id="registerBtn">🎙️ Rekam Suara untuk Registrasi</button>
                
                <div class="recording-controls" id="registerControls">
                    <button id="cancelRegisterBtn" class="cancel-btn">❌ Batalkan Perekaman</button>
                </div>
                
                <div class="status" id="registerStatus"></div>
                <div class="waveform" id="registerWaveform" style="display: none;">
                    <div class="wave-bar" style="animation-delay: 0s; height: 20px;"></div>
                    <div class="wave-bar" style="animation-delay: 0.1s; height: 30px;"></div>
                    <div class="wave-bar" style="animation-delay: 0.2s; height: 25px;"></div>
                    <div class="wave-bar" style="animation-delay: 0.3s; height: 40px;"></div>
                    <div class="wave-bar" style="animation-delay: 0.4s; height: 20px;"></div>
                    <div class="wave-bar" style="animation-delay: 0.5s; height: 35px;"></div>
                    <div class="wave-bar" style="animation-delay: 0.6s; height: 25px;"></div>
                    <div class="wave-bar" style="animation-delay: 0.7s; height: 30px;"></div>
                </div>
                
                <div class="voice-list" id="voiceList">
                    <div style="text-align: center; color: #a0aec0;">Belum ada suara yang terdaftar</div>
                </div>
            </div>
        </div>

        <!-- Absen Tab -->
        <div class="tab-content" id="attendanceTab">
            <div class="section">
                <h2>Absen Kehadiran</h2>
                <button id="attendanceBtn">🎯 Mulai Absen dengan Suara</button>
                
                <div class="recording-controls" id="attendanceControls">
                    <button id="cancelAttendanceBtn" class="cancel-btn">❌ Batalkan Perekaman</button>
                    <button id="retryAttendanceBtn" class="cancel-btn" style="display: none;">🔄 Coba Lagi</button>
                </div>
                
                <div class="status" id="attendanceStatus"></div>
                <div class="waveform" id="attendanceWaveform" style="display: none;">
                    <div class="wave-bar" style="animation-delay: 0s; height: 25px;"></div>
                    <div class="wave-bar" style="animation-delay: 0.1s; height: 35px;"></div>
                    <div class="wave-bar" style="animation-delay: 0.2s; height: 30px;"></div>
                    <div class="wave-bar" style="animation-delay: 0.3s; height: 45px;"></div>
                    <div class="wave-bar" style="animation-delay: 0.4s; height: 25px;"></div>
                    <div class="wave-bar" style="animation-delay: 0.5s; height: 40px;"></div>
                    <div class="wave-bar" style="animation-delay: 0.6s; height: 30px;"></div>
                    <div class="wave-bar" style="animation-delay: 0.7s; height: 35px;"></div>
                </div>
                
                <div class="result" id="result"></div>
            </div>
        </div>

        <!-- Admin Tab -->
        <div class="tab-content" id="adminTab">
            <div class="section">
                <h2>Panel Admin</h2>
                
                <!-- Statistics -->
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalStudents">0</div>
                        <div class="stat-label">Total Siswa Terdaftar</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todayAttendance">0</div>
                        <div class="stat-label">Hadir Hari Ini</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lateToday">0</div>
                        <div class="stat-label">Terlambat Hari Ini</div>
                    </div>
                </div>

                <!-- Admin Controls -->
                <div class="admin-controls">
                    <div class="time-settings">
                        <label for="lateTimeInput">Batas Waktu Terlambat:</label>
                        <input type="time" id="lateTimeInput" value="07:30" style="width: 150px;">
                        <button onclick="updateLateTime()">💾 Simpan</button>
                    </div>
                    <div>
                        <button onclick="clearAllAttendance()" class="delete-btn">🗑️ Hapus Semua Data Kehadiran</button>
                        <button onclick="exportAttendance()">📊 Export Data</button>
                    </div>
                </div>

                <!-- Attendance List -->
                <h3>Data Kehadiran Hari Ini</h3>
                <div class="attendance-list" id="attendanceList">
                    <div style="text-align: center; color: #a0aec0;">Belum ada data kehadiran hari ini</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class VoiceAttendanceSystem {
            constructor() {
                this.registeredVoices = [];
                this.attendanceRecords = [];
                this.isRecording = false;
                this.mediaRecorder = null;
                this.audioContext = null;
                this.analyser = null;
                this.currentRecordingType = null;
                this.lateTime = '07:30';
                
                this.initializeElements();
                this.bindEvents();
                this.loadData();
                this.updateCurrentTime();
                this.startTimeUpdater();
            }

            initializeElements() {
                this.nameInput = document.getElementById('nameInput');
                this.classInput = document.getElementById('classInput');
                this.registerBtn = document.getElementById('registerBtn');
                this.attendanceBtn = document.getElementById('attendanceBtn');
                this.cancelRegisterBtn = document.getElementById('cancelRegisterBtn');
                this.cancelAttendanceBtn = document.getElementById('cancelAttendanceBtn');
                this.retryAttendanceBtn = document.getElementById('retryAttendanceBtn');
                this.registerStatus = document.getElementById('registerStatus');
                this.attendanceStatus = document.getElementById('attendanceStatus');
                this.voiceList = document.getElementById('voiceList');
                this.attendanceList = document.getElementById('attendanceList');
                this.result = document.getElementById('result');
                this.registerWaveform = document.getElementById('registerWaveform');
                this.attendanceWaveform = document.getElementById('attendanceWaveform');
                this.registerControls = document.getElementById('registerControls');
                this.attendanceControls = document.getElementById('attendanceControls');
                this.lateTimeInput = document.getElementById('lateTimeInput');
                this.currentTimeDisplay = document.getElementById('currentTime');
            }

            bindEvents() {
                this.registerBtn.addEventListener('click', () => this.handleRegisterVoice());
                this.attendanceBtn.addEventListener('click', () => this.handleAttendance());
                this.cancelRegisterBtn.addEventListener('click', () => this.cancelRecording('register'));
                this.cancelAttendanceBtn.addEventListener('click', () => this.cancelRecording('attendance'));
                this.retryAttendanceBtn.addEventListener('click', () => this.retryAttendance());
            }

            startTimeUpdater() {
                setInterval(() => {
                    this.updateCurrentTime();
                }, 1000);
            }

            updateCurrentTime() {
                const now = new Date();
                const timeString = now.toLocaleString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                this.currentTimeDisplay.textContent = `⏰ ${timeString}`;
            }

            async requestMicrophoneAccess() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        } 
                    });
                    return stream;
                } catch (error) {
                    throw new Error('Mikrof tidak dapat diakses. Pastikan Anda memberikan izin.');
                }
            }

            async startRecording(type) {
                try {
                    const stream = await this.requestMicrophoneAccess();
                    
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const source = this.audioContext.createMediaStreamSource(stream);
                    this.analyser = this.audioContext.createAnalyser();
                    source.connect(this.analyser);
                    
                    this.mediaRecorder = new MediaRecorder(stream);
                    const audioChunks = [];
                    this.currentRecordingType = type;

                    this.mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };

                    this.mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        this.processRecording(audioBlob, type);
                        stream.getTracks().forEach(track => track.stop());
                    };

                    this.mediaRecorder.start();
                    this.isRecording = true;

                    // Update UI
                    this.updateRecordingUI(type, true);

                    // Auto stop after 5 seconds
                    setTimeout(() => {
                        if (this.isRecording && this.currentRecordingType === type) {
                            this.stopRecording(type);
                        }
                    }, 5000);

                } catch (error) {
                    this.showError(error.message);
                }
            }

            updateRecordingUI(type, isRecording) {
                const btn = type === 'register' ? this.registerBtn : this.attendanceBtn;
                const status = type === 'register' ? this.registerStatus : this.attendanceStatus;
                const waveform = type === 'register' ? this.registerWaveform : this.attendanceWaveform;
                const controls = type === 'register' ? this.registerControls : this.attendanceControls;
                
                if (isRecording) {
                    btn.textContent = '⏹️ Stop Recording';
                    btn.classList.add('recording');
                    status.textContent = 'Sedang merekam... Silakan bicara dengan jelas';
                    waveform.style.display = 'flex';
                    controls.classList.add('show');
                } else {
                    btn.classList.remove('recording');
                    waveform.style.display = 'none';
                    controls.classList.remove('show');
                    
                    if (type === 'register') {
                        this.registerBtn.textContent = '🎙️ Rekam Suara untuk Registrasi';
                    } else {
                        this.attendanceBtn.textContent = '🎯 Mulai Absen dengan Suara';
                    }
                }
            }

            stopRecording(type) {
                if (this.mediaRecorder && this.isRecording && this.currentRecordingType === type) {
                    this.mediaRecorder.stop();
                    this.isRecording = false;
                    this.currentRecordingType = null;
                    
                    this.updateRecordingUI(type, false);
                    
                    const status = type === 'register' ? this.registerStatus : this.attendanceStatus;
                    status.textContent = 'Memproses rekaman...';
                }
            }

            cancelRecording(type) {
                if (this.mediaRecorder && this.isRecording && this.currentRecordingType === type) {
                    this.mediaRecorder.stop();
                    this.isRecording = false;
                    this.currentRecordingType = null;
                    
                    this.updateRecordingUI(type, false);
                    
                    const status = type === 'register' ? this.registerStatus : this.attendanceStatus;
                    status.textContent = 'Perekaman dibatalkan';
                    
                    setTimeout(() => {
                        status.textContent = '';
                    }, 2000);
                }
            }

            retryAttendance() {
                this.result.classList.remove('show');
                this.attendanceStatus.textContent = '';
                this.retryAttendanceBtn.style.display = 'none';
                setTimeout(() => {
                    this.handleAttendance();
                }, 500);
            }

            async processRecording(audioBlob, type) {
                try {
                    const arrayBuffer = await audioBlob.arrayBuffer();
                    const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
                    const voiceSignature = this.extractVoiceFeatures(audioBuffer);
                    
                    if (type === 'register') {
                        await this.registerVoice(voiceSignature);
                    } else {
                        await this.matchVoice(voiceSignature);
                    }
                } catch (error) {
                    this.showError('Gagal memproses rekaman suara');
                }
            }

            extractVoiceFeatures(audioBuffer) {
                const channelData = audioBuffer.getChannelData(0);
                const features = {
                    duration: audioBuffer.duration,
                    sampleRate: audioBuffer.sampleRate,
                    rms: this.calculateRMS(channelData),
                    zeroCrossings: this.calculateZeroCrossings(channelData),
                    spectralCentroid: this.calculateSpectralCentroid(channelData),
                    timestamp: Date.now()
                };
                
                return features;
            }

            calculateRMS(data) {
                let sum = 0;
                for (let i = 0; i < data.length; i++) {
                    sum += data[i] * data[i];
                }
                return Math.sqrt(sum / data.length);
            }

            calculateZeroCrossings(data) {
                let crossings = 0;
                for (let i = 1; i < data.length; i++) {
                    if ((data[i] >= 0) !== (data[i - 1] >= 0)) {
                        crossings++;
                    }
                }
                return crossings;
            }

            calculateSpectralCentroid(data) {
                return data.reduce((sum, val, idx) => sum + Math.abs(val) * idx, 0) / data.length;
            }

            async registerVoice(voiceSignature) {
                const name = this.nameInput.value.trim();
                const studentClass = this.classInput.value;
                
                if (!name) {
                    this.showError('Silakan masukkan nama terlebih dahulu');
                    return;
                }

                if (!studentClass) {
                    this.showError('Silakan pilih kelas terlebih dahulu');
                    return;
                }

                if (this.registeredVoices.find(v => v.name.toLowerCase() === name.toLowerCase())) {
                    this.showError('Nama sudah terdaftar. Gunakan nama lain.');
                    return;
                }

                const voiceData = {
                    id: Date.now(),
                    name: name,
                    class: studentClass,
                    features: voiceSignature,
                    registeredAt: new Date().toLocaleString('id-ID')
                };

                this.registeredVoices.push(voiceData);
                this.saveData();
                this.updateVoiceList();
                this.updateStats();
                
                this.registerStatus.textContent = `✅ Suara ${name} (${studentClass}) berhasil didaftarkan!`;
                this.nameInput.value = '';
                this.classInput.value = '';
                
                setTimeout(() => {
                    this.registerStatus.textContent = '';
                }, 3000);
            }

            async matchVoice(voiceSignature) {
                if (this.registeredVoices.length === 0) {
                    this.showResult('error', 'Belum ada suara yang terdaftar. Silakan daftar terlebih dahulu.');
                    this.showRetryButton();
                    return;
                }

                let bestMatch = null;
                let bestScore = 0;
                const threshold = 0.7;

                for (const registered of this.registeredVoices) {
                    const score = this.calculateSimilarity(voiceSignature, registered.features);
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = registered;
                    }
                }

                this.attendanceStatus.textContent = '';

                if (bestMatch && bestScore > threshold) {
                    // Check if already attended today
                    const today = new Date().toDateString();
                    const alreadyAttended = this.attendanceRecords.find(
                        record => record.studentId === bestMatch.id && 
                                 new Date(record.timestamp).toDateString() === today
                    );

                    if (alreadyAttended) {
                        this.showResult('warning', `${bestMatch.name} sudah melakukan absen hari ini pada ${alreadyAttended.time}`);
                        this.showRetryButton();
                        return;
                    }

                    // Record attendance
                    const now = new Date();
                    const currentTime = now.toTimeString().slice(0, 5);
                    const isLate = this.isStudentLate(currentTime);

                    const attendanceRecord = {
                        id: Date.now(),
                        studentId: bestMatch.id,
                        name: bestMatch.name,
                        class: bestMatch.class,
                        timestamp: now.toISOString(),
                        date: now.toDateString(),
                        time: currentTime,
                        isLate: isLate,
                        similarity: Math.round(bestScore * 100)
                    };

                    this.attendanceRecords.push(attendanceRecord);
                    this.saveData();
                    this.updateAttendanceList();
                    this.updateStats();

                    const statusText = isLate ? 'TERLAMBAT' : 'TEPAT WAKTU';
                    const resultType = isLate ? 'warning' : 'success';
                    
                    this.showResult(resultType, 
                        `Nama: ${bestMatch.name}\n` +
                        `Kelas: ${bestMatch.class}\n` +
                        `Kehadiran terekam: ${statusText}\n` +
                        `Waktu: ${now.toLocaleString('id-ID')}\n` +
                        `Tingkat kemiripan: ${Math.round(bestScore * 100)}%`
                    );
                } else {
                    this.showResult('error', 'Suara tidak dikenali. Silakan coba lagi atau daftar terlebih dahulu.');
                    this.showRetryButton();
                }
            }

            isStudentLate(currentTime) {
                const [currentHour, currentMinute] = currentTime.split(':').map(Number);
                const [lateHour, lateMinute] = this.lateTime.split(':').map(Number);
                
                const currentTotalMinutes = currentHour * 60 + currentMinute;
                const lateTotalMinutes = lateHour * 60 + lateMinute;
                
                return currentTotalMinutes > lateTotalMinutes;
            }

            showRetryButton() {
                this.retryAttendanceBtn.style.display = 'inline-block';
            }

            calculateSimilarity(voice1, voice2) {
                const rmsDiff = Math.abs(voice1.rms - voice2.rms);
                const zcDiff = Math.abs(voice1.zeroCrossings - voice2.zeroCrossings);
                const scDiff = Math.abs(voice1.spectralCentroid - voice2.spectralCentroid);
                
                const rmsScore = Math.max(0, 1 - (rmsDiff / Math.max(voice1.rms, voice2.rms)));
                const zcScore = Math.max(0, 1 - (zcDiff / Math.max(voice1.zeroCrossings, voice2.zeroCrossings)));
                const scScore = Math.max(0, 1 - (scDiff / Math.max(voice1.spectralCentroid, voice2.spectralCentroid)));
                
                return (rmsScore * 0.4 + zcScore * 0.3 + scScore * 0.3);
            }

            handleRegisterVoice() {
                if (this.isRecording && this.currentRecordingType === 'register') {
                    this.stopRecording('register');
                } else if (!this.isRecording) {
                    this.startRecording('register');
                }
            }

            handleAttendance() {
                if (this.isRecording && this.currentRecordingType === 'attendance') {
                    this.stopRecording('attendance');
                } else if (!this.isRecording) {
                    this.startRecording('attendance');
                }
            }

            showResult(type, message) {
                this.result.className = `result ${type}`;
                this.result.textContent = message;
                this.result.classList.add('show');
                
                setTimeout(() => {
                    this.result.classList.remove('show');
                }, 8000);
            }

            showError(message) {
                this.showResult('error', message);
            }

            updateVoiceList() {
                if (this.registeredVoices.length === 0) {
                    this.voiceList.innerHTML = '<div style="text-align: center; color: #a0aec0;">Belum ada suara yang terdaftar</div>';
                    return;
                }

                this.voiceList.innerHTML = this.registeredVoices.map(voice => `
                    <div class="voice-item">
                        <div>
                            <strong>${voice.name}</strong> - ${voice.class}<br>
                            <small>Terdaftar: ${voice.registeredAt}</small>
                        </div>
                        <button class="delete-btn" onclick="attendanceSystem.deleteVoice(${voice.id})">🗑️ Hapus</button>
                    </div>
                `).join('');
            }

            updateAttendanceList() {
                const today = new Date().toDateString();
                const todayAttendance = this.attendanceRecords.filter(
                    record => new Date(record.timestamp).toDateString() === today
                ).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                if (todayAttendance.length === 0) {
                    this.attendanceList.innerHTML = '<div style="text-align: center; color: #a0aec0;">Belum ada data kehadiran hari ini</div>';
                    return;
                }

                this.attendanceList.innerHTML = todayAttendance.map(record => `
                    <div class="attendance-item">
                        <div>
                            <strong>${record.name}</strong> - ${record.class}
                            ${record.isLate ? 
                                '<span class="late-badge">TERLAMBAT</span>' : 
                                '<span class="on-time-badge">TEPAT WAKTU</span>'
                            }<br>
                            <small>Waktu: ${record.time} | Kemiripan: ${record.similarity}%</small>
                        </div>
                        <button class="delete-btn" onclick="attendanceSystem.deleteAttendance(${record.id})">🗑️ Hapus</button>
                    </div>
                `).join('');
            }

            updateStats() {
                const today = new Date().toDateString();
                const todayAttendance = this.attendanceRecords.filter(
                    record => new Date(record.timestamp).toDateString() === today
                );
                const lateToday = todayAttendance.filter(record => record.isLate).length;

                document.getElementById('totalStudents').textContent = this.registeredVoices.length;
                document.getElementById('todayAttendance').textContent = todayAttendance.length;
                document.getElementById('lateToday').textContent = lateToday;
            }

            deleteVoice(id) {
                if (confirm('Apakah Anda yakin ingin menghapus data siswa ini?')) {
                    this.registeredVoices = this.registeredVoices.filter(voice => voice.id !== id);
                    // Also remove attendance records for this student
                    this.attendanceRecords = this.attendanceRecords.filter(record => record.studentId !== id);
                    this.saveData();
                    this.updateVoiceList();
                    this.updateAttendanceList();
                    this.updateStats();
                }
            }

            deleteAttendance(id) {
                if (confirm('Apakah Anda yakin ingin menghapus data kehadiran ini?')) {
                    this.attendanceRecords = this.attendanceRecords.filter(record => record.id !== id);
                    this.saveData();
                    this.updateAttendanceList();
                    this.updateStats();
                }
            }

            saveData() {
                // In a real application, this would save to a database
                // For demo purposes, we keep it in memory
                console.log('Data saved:', {
                    voices: this.registeredVoices.length,
                    attendance: this.attendanceRecords.length
                });
            }

            loadData() {
                // In a real application, this would load from a database
                this.updateVoiceList();
                this.updateAttendanceList();
                this.updateStats();
                this.lateTimeInput.value = this.lateTime;
            }
        }

        // Global functions for admin panel
        function switchTab(tabName) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function updateLateTime() {
            const newTime = document.getElementById('lateTimeInput').value;
            if (newTime) {
                attendanceSystem.lateTime = newTime;
                attendanceSystem.saveData();
                alert('Batas waktu terlambat berhasil diperbarui!');
            }
        }

        function clearAllAttendance() {
            if (confirm('Apakah Anda yakin ingin menghapus SEMUA data kehadiran? Tindakan ini tidak dapat dibatalkan!')) {
                attendanceSystem.attendanceRecords = [];
                attendanceSystem.saveData();
                attendanceSystem.updateAttendanceList();
                attendanceSystem.updateStats();
                alert('Semua data kehadiran telah dihapus!');
            }
        }

        function exportAttendance() {
            const today = new Date().toDateString();
            const todayAttendance = attendanceSystem.attendanceRecords.filter(
                record => new Date(record.timestamp).toDateString() === today
            );

            if (todayAttendance.length === 0) {
                alert('Tidak ada data kehadiran untuk diekspor hari ini.');
                return;
            }

            let csvContent = 'Nama,Kelas,Waktu,Status,Tingkat Kemiripan\n';
            todayAttendance.forEach(record => {
                const status = record.isLate ? 'TERLAMBAT' : 'TEPAT WAKTU';
                csvContent += `${record.name},${record.class},${record.time},${status},${record.similarity}%\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kehadiran_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Initialize the system
        const attendanceSystem = new VoiceAttendanceSystem();
    </script>
</body>
</html>